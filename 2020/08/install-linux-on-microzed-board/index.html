<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158845844-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-158845844-1');</script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery-cookiebar/1.0.5/jquery.cookiebar.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/jquery-cookiebar/1.0.5/jquery.cookiebar.css><script type=text/javascript>$(document).ready(function(){$.cookieBar({fixed:true,acceptOnScroll:600,policyURL:'/privacy-policy/',policyButton:true,policyText:'Privacy Policy',expireDays:45});});</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body);></script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>install linux on microzed board</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="linux image for microzed development board with yocto"><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css><link rel=stylesheet href=https://yairgd.github.io/css/blog.css></head><body><nav class="navbar is-fixed-top" role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=https://yairgd.github.io/>Home</a>
<a class=navbar-item href=/about>About</a>
<a class=navbar-item href=/blogs>Blog</a>
<a class=navbar-item href=/cv>CV</a>
<a class=navbar-item href=/projects>Projects</a></div></nav><section class="hero is-info is-medium"><div class=hero-body style=background-image:url(https://yairgd.github.io/img/bg-blog1.jpg)><div class="container has-text-centered"><br><h1 class="title is-size-1">install linux on microzed board</h1></div></div></section><div class=container><div class=section><div class=columns><div class="column is-9"><div class="tile is-child box"><div class=content><article class=media><div class=media-content><div class=content><p class="title is-5"><a href=https://yairgd.github.io/2020/08/install-linux-on-microzed-board/>install linux on microzed board</a></p><p class="subtitle is-size-6 has-text-grey-light">Published at August 1, 2020 &#183;
<i class="far fa-clock"></i>&nbsp;4 min read
&#183; Tags:
<a href=https://yairgd.github.io/tags/zynq/>zynq</a>
<a href=https://yairgd.github.io/tags/yocto/>yocto</a></p></br></div></div></article><p>The <a href=http://zedboard.org/product/microzed>microzed</a> development board has Xilinx zynq7000 chip. It has an application process unit with cortex a9 and FPGA fabric. The board also contains interfaces like SDIO and QSPI. I want to install Linux on it directly with yocto and without petalinux, which runs yocto behind the scene, so I tried to eliminate the need to use it. Why do so?</p><ul><li>It is interesting, and I have a lot of experience with yocto and it very easy to work with its script once you know it</li><li>easy porting to other processors: IMX, stm32Mp157, etc&rsquo;</li><li>using build tools like CMake,Autotools, and yocto scripts make it very easy to port SW between different processors.</li></ul><p>I found the <a href=https://github.com/Xilinx/meta-xilinx>meta-xilinx</a> layer and used it to build a Linux system for the microzed board. Refer <a href=https://github.com/Xilinx/meta-xilinx/tree/master/meta-xilinx-bsp/conf/machine>here</a> for a list supported bords and creating a custom board can be very easy if one tracks the existing ones.</p><h2 id=yocto-installation>yocto installation</h2><p>The basic yocto installation includes poky and meta-Xilinx layers; check out the following yocto layers and switch to zeus branch:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir yocto
cd yocto
git clone git://git.yoctoproject.org/poky.git
git clone https://github.com/Xilinx/meta-xilinx
git clone http://github.com/Xilinx/meta-xilinx-tools
. ./poky/oe-init-build-env
</code></pre></div><p>add the meta-xilinx layers:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bitbake-layers add-layer /path/to/meta-xilinx
bitbake-layers add-layer /path/to/meta-xilinx-tools
</code></pre></div><p>and change the configration file conf/local.conf:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># to build microzed board</span>
MACHINE ??<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;microzed-zynq7&#34;</span>
<span style=color:#75715e># to allow c++</span> 
IMAGE_INSTALL_append <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; libstdc++&#34;</span>
TOOLCHAIN_TARGET_TASK_append <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; libstdc++-staticdev&#34;</span>
</code></pre></div><p>Use the following yocto builds:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># to create minimal CPIO image (3M Bytes) + kernel + u-boot</span>
bitbake core-image-minimal
bitbake u-boot
</code></pre></div><h3 id=flash-image-on-qspi>flash image on QSPI</h3><h4 id=fsbl>FSBL</h4><p>generate FSBL for microzed platform board. The board definition files (BDF) sould be instaled on vivado as reffer <a href=https://github.com/Avent/bdf>here</a>.</p><h4 id=bootbin>boot.bin</h4><p>To create the boot.bin file, we can use bootgen, which is a tool of Xilinx or to use <a href=https://github.com/antmicro/zynq-mkbootimage>mkbootimage</a> which is an open-source replacement for Xilinx bootgen tool. I took the values of the parameters load and offset address from the u-boot file <a href=https://gitlab.denx.de/u-boot/u-boot/-/blob/master/include/configs/zynq-common.h>zynq-common.h</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>UIMAGE_LOAD<span style=color:#f92672>=</span>0x3000000
DTB_LOAD<span style=color:#f92672>=</span>0x2a00000
FS_LOAD<span style=color:#f92672>=</span>0x2000000

KERNEL_ENTRY<span style=color:#f92672>=</span>0x100000
DTS_ENTRY<span style=color:#f92672>=</span>0x600000
RAM_FS_ENTRY<span style=color:#f92672>=</span>0x620000

cat <span style=color:#e6db74>&lt;&lt; EOF &gt; boot.bif
</span><span style=color:#e6db74>img : { 
</span><span style=color:#e6db74>	[bootloader]/home/yair/workspace2/fsbl_microzed/Release/fsbl_microzed.elf
</span><span style=color:#e6db74>	/home/yair/xilinx/yocto/build/tmp/work/microzed_zynq7-poky-linux-gnueabi/u-boot/1_2019.07-r0/build/u-boot.elf
</span><span style=color:#e6db74>	[load=${UIMAGE_LOAD},offset=${KERNEL_ENTRY}]yocto/build/tmp/work/microzed_zynq7-poky-linux-gnueabi/linux-xlnx/4.19-xilinx-v2019.2+gitAUTOINC+b983d5fd71-r0/deploy-linux-xnx/uImage	
</span><span style=color:#e6db74>	[load=${DTB_LOAD},offset=${DTS_ENTRY}]yocto/build/tmp/work/microzed_zynq7-poky-linux-gnueabi/linux-xlnx/4.19-xilinx-v2019.2+gitAUTOINC+b983d5fd71-r0/deploy-linux-xlnx/zynq-microzed-microzed-zynq7.dtb	
</span><span style=color:#e6db74>	[load=${FS_LOAD},offset=${RAM_FS_ENTRY}]yocto/build/tmp/deploy/images/microzed-zynq7/core-image-minimal-microzed-zynq7.cpio.gz.u-boot
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74>EOF</span>
bootgen  -image boot.bif -o i boot.bin -w 
</code></pre></div><h4 id=flash-the-board>flash the board</h4><p>To flash the image on the qspi is has to set the board at jtag init mode and run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>program_flash -f /path/to/boot.bin -offset <span style=color:#ae81ff>0</span> -flash_type qspi_single -fsbl /path/to/fsbl_microzed.elf -blank_check -verify -cable type xilinx_tcf url TCP:127.0.0.1:3121
</code></pre></div><h4 id=manual-boot>manual boot</h4><p>This u-boot commands will read files from QSPI and will load the Linux kernel it can also automated using u-boot enviroment variables and scripts.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sf read 0x2000000 0x620000 0x500000
sf read 0x3000000 0x100000 0x5e0000
sf read 0x2a00000 0x600000 0x20000
bootm  0x3000000  0x2000000 0x2a00000
</code></pre></div><h3 id=boot-image-on-sd-card>boot image on sd card</h3><p>The stages for flashing images on the sd card are similar to those that have on the QSPI. But I was to use a completely open-source without FSBL. The idea is to take the <em>boot.bin</em> file ( generated using vivado tools) and replace it with the secondary boot loader (SPL). The most important file is <a href=https://gitlab.denx.de/u-boot/u-boot/-/blob/master/board/xilinx/zynq/zynq-microzed/ps7_init_gpl.c>ps7_init_gpl.c</a> which one create it using vivado tools, and it also platforms unique and responsible to initialize the most critical peripherals in the board: The DDR controller, clocks and MIO pins. If a new platform is a design, then, is has to generate a new file for the new platform. The following bash script creates a binary boot image file, and its name should be <em>boot.bin</em>. It has to copy the following files to the sd card, refer <a href=https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18841976/Prepare+boot+image>here</a> for more details:</p><style>table{display:block;max-width:-moz-fit-content;max-width:fit-content;margin:0 auto;overflow-x:auto}table th:nth-of-type(1){width:10%}table th:nth-of-type(2){width:10%}table th:nth-of-type(3){width:80%;white-space:nowrap}</style><div style=overflow:auto;width:auto><table><thead><tr><th>file</th><th>name on sd card</th><th>note</th></tr></thead><tbody><tr><td>boot.bin</td><td>BOOT.bin</td><td>replace the previous boot.bin</td></tr><tr><td>yocto/build/tmp/work/microzed_zynq7-poky-linux-gnueabi/linux-xlnx/4.19-xilinx-v2019.2+gitAUTOINC+b983d5fd71-r0/deploy-linux-xnx/uImage</td><td>uImage</td><td>u-boot image of linux kernel</td></tr><tr><td>yocto/build/tmp/deploy/images/microzed-zynq7/core-image-minimal-microzed-zynq7.cpio.gz.u-boot</td><td>uramdisk.image.gz</td><td>u-boot image of compressed CPIO file system</td></tr><tr><td>yocto/build/tmp/work/microzed_zynq7-poky-linux-gnueabi/u-boot/1_2019.07-r0/build/u-boot.img</td><td>u-boot.img</td><td>It is a u-boot image that contains u-boot.bin, and the SPL loads it from sd card extract the u-boot.bin and loads it to memory. <a href=https://github.com/Xilinx/u-boot-xlnx/blob/master/include/configs/zynq-common.h>Reffer</a> here to the default name <em>u-boot.img</em> that is used by SPL</td></tr></tbody></table></div><p>The names mentioned in the table above, are arrived from the file <em>boot.cmd</em> which process of yocto build generates that file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ yocto/build/tmp/work/microzed_zynq7-poky-linux-gnueabi/u-boot-zynq-scr/1.0-r0 $ cat boot.cmd
fatload mmc <span style=color:#ae81ff>0</span> 0x2000000 zynq-microzed.dtb
fatload mmc <span style=color:#ae81ff>0</span> 0x2080000 uImage
fatload mmc <span style=color:#ae81ff>0</span> 0x4000000 uramdisk.image.gz
bootm 0x2080000 0x4000000 0x2000000
</code></pre></div><h3 id=to-do-install-boot-image-on-qspi-with-spl>TO do: Install boot image on QSPI with SPL</h3><p>To eliminate the FSBL when using QSPI.</p><h2 id=references>References</h2><p>[1] <a href=https://www.xilinx.com/html_docs/xilinx2018_1/SDK_Doc/xsct/use_cases/xsct_create_bootable_image.html>Creating a Bootable Image and Program the Flash</a></p></div><div class=content><div class=disqus-comments>Comments<div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"yairgd-github-io-1"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><div class="column is-3"><div class=card><div class=card-content><h1 class="title is-5">Categories</h1><div class=tags><span class=tag><a href=https://yairgd.github.io/categories/algorithm>algorithm</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/development>development</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/embbeded>embbeded</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/golang>golang</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/linux>linux</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/python>python</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/qt5>qt5</a></span></div></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Tags</h1><div class=tags><span class=tag><a href=https://yairgd.github.io/tags/bayer>bayer</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/computer-vision>computer-vision</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/development>development</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/embedded>embedded</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/go>go</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/golang>golang</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/hugo>hugo</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/kalman-filter>kalman-filter</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/kernel>kernel</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/linux>linux</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/opkg>opkg</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/qt5>qt5</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/rgb>rgb</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/rt>rt</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/statstical-abitrage>statstical-abitrage</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/templates>templates</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/themes>themes</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/yocto>yocto</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/zynq>zynq</a></span></div></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Recent posts</h1><h1><a href=https://yairgd.github.io/2020/08/install-linux-on-microzed-board/>install linux on microzed board</a></h1><time class="has-text-grey-light is-size-7">1 August 2020</time><h1><a href=https://yairgd.github.io/2020/06/custom-opkg-repository/>Custom opkg repository</a></h1><time class="has-text-grey-light is-size-7">18 June 2020</time><h1><a href=https://yairgd.github.io/2020/05/kalman-filter-and-pair-trading/>Kalman filter and pair trading</a></h1><time class="has-text-grey-light is-size-7">1 May 2020</time><h1><a href=https://yairgd.github.io/2020/04/simple-hello-world-application-using-qt5-for-embedded-linux-device./>Simple Hello World application using qt5 for embedded Linux device.</a></h1><time class="has-text-grey-light is-size-7">1 April 2020</time><h1><a href=https://yairgd.github.io/2020/03/debug-linux-kernel-with-qemu/>Debug Linux Kernel With Qemu</a></h1><time class="has-text-grey-light is-size-7">18 March 2020</time></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Related posts</h1><h1><a href=https://yairgd.github.io/2020/06/custom-opkg-repository/>Custom opkg repository</a></h1><time class="has-text-grey-light is-size-7">18 June 2020</time><h1><a href=https://yairgd.github.io/2020/02/install-yocto-and-kernel-development-tools-of-imx8/>Install Yocto and kernel development tools of IMX8</a></h1><time class="has-text-grey-light is-size-7">24 February 2020</time></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Archives</h1><a href=https://yairgd.github.io/archives/2020>2020</a> (13)<br><a href=https://yairgd.github.io/archives/2014>2014</a> (4)<br></div></div></div></div></div></div><footer class="footer has-background-grey-darker has-text-white"><div class="content has-text-centered"><p><span class="icon is-large"><a href="https://m.facebook.com/yair.gadelov?ref=bookmarks" class=mysocial rel=me><i class="fab fa-facebook fa-3x"></i></a></span>&nbsp;&nbsp;
<span class="icon is-large"><a href=https://www.linkedin.com/mwlite/in/yair-gadelov-1972ab17/ class=mysocial rel=me><i class="fab fa-linkedin fa-3x"></i></a></span>&nbsp;&nbsp;
<span class="icon is-large"><a href=https://github.com/yairgd/ class=mysocial rel=me><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;<br><br>Copyright &copy; Yair Gadelov Tech Blog 2020 - Theme by <a href=https://jeffprod.com class=mysocial>JeffProd.com</a>
- <a class=mysocial href=https://yairgd.github.io/about>About</a><br></p></div></footer><script defer src=https://use.fontawesome.com/releases/v5.1.0/js/all.js></script></body></html>