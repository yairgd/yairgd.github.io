<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158845844-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-158845844-1');</script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery-cookiebar/1.0.5/jquery.cookiebar.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/jquery-cookiebar/1.0.5/jquery.cookiebar.css><script type=text/javascript>$(document).ready(function(){$.cookieBar({fixed:true,acceptOnScroll:600,policyURL:'/privacy-policy/',policyButton:true,policyText:'Privacy Policy',expireDays:45});});</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body);></script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Simple OpenAMP application for stm32mp157</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="How to build the Linux kernel for zynq in separate and not as part of the yocto build."><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css><link rel=stylesheet href=https://yairgd.github.io/css/blog.css></head><body><nav class="navbar is-fixed-top" role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=https://yairgd.github.io/>Home</a>
<a class=navbar-item href=/pages/about>About</a>
<a class=navbar-item href=/blog>Blog</a>
<a class=navbar-item href=/pages/cv>CV</a>
<a class=navbar-item href=/projects>Projects</a>
<a class=navbar-item href=/pages/search>Search</a></div></nav><section class="hero is-info is-medium"><div class=hero-body style=background-image:url(https://yairgd.github.io/img/bg-blog1.jpg)><div class="container has-text-centered"><br><h1 class="title is-size-1">Simple OpenAMP application for stm32mp157</h1></div></div></section><div class=container><div class=section><div class=columns><div class="column is-9"><div class="tile is-child box"><div class=content><article class=media><div class=media-content><div class=content><p class="title is-5"><a href=https://yairgd.github.io/2020/10/simple-openamp-application-for-stm32mp157/>Simple OpenAMP application for stm32mp157</a></p><p class="subtitle is-size-6 has-text-grey-light">Published at October 25, 2020 &#183;
<i class="far fa-clock"></i>&nbsp;3 min read
&#183; Tags:
<a href=https://yairgd.github.io/tags/linux/>linux</a>
<a href=https://yairgd.github.io/tags/kernel/>kernel</a>
<a href=https://yairgd.github.io/tags/yocto/>yocto</a>
<a href=https://yairgd.github.io/tags/stm32/>stm32</a></p></br></div></div></article><p>The <a href=https://www.st.com/en/microcontrollers-microprocessors/stm32mp157.html>stm32mp157</a> is SOC from STMicrocntrollers, and it has within it a dual-core Cortex-A7 MPU and Cortex-M4 MCU. The Cortex-A7 is the application processor that operates Linux, and the Cortex-m4 runs RTOS or bare-metal application. The Cortex-M4 can be used for real-time tasks, such as creating a periodic and accurate control signal without jitter. In this kind of application, the Cortex-aA7 will run the master application and control the application of the Cortex-m4 using <a href=https://github.com/OpenAMP/open-amp/wiki/RPMsg-Messaging-Protocol>RPMsg Messaging Protocol</a>. I have used <a href=https://www.st.com/en/evaluation-tools/stm32mp157c-dk2.html#>STM32MP157C-DK2</a> evaluation kit to create a simple hello world messaging application between Cortex-a7 (Linux) to Cortex-M4 (bare metal)</p><h2 id=install-necessary-tools>install necessary tools</h2><p>The working environment is Linux and usually and I had to install <a href=https://gerrit.googlesource.com/git-repo/>repo</a> tool (Gentoo)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>emerge dev-vcs/repo
</code></pre></div><p>I had followed the instruction in this manual <a href=https://wiki.st.com/stm32mpu/index.php/STM32MP1_Distribution_Package>ref</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir yocto
cd yocto
repo init -u https://github.com/STMicroelectronics/oe-manifest.git -b refs/tags/openstlinux-5.4-dunfell-mp1-20-06-24
repo sync
</code></pre></div><p>Build yocto image and toolchain:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>DISTRO<span style=color:#f92672>=</span>openstlinux-weston MACHINE<span style=color:#f92672>=</span>stm32mp1 source layers/meta-st/scripts/envsetup.sh
bitbake core-image-base
bitbake meta-toolchain
bitbake st-image-weston
</code></pre></div><p>To install the tool can make sure that you are in the build directory (<em>build-openstlinuxweston-stm32mp1</em> - by default) and type:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>. meta-toolchain-openstlinux-weston-stm32mp1-x86_64-toolchain-3.1-snapshot.sh
</code></pre></div><p>ST recommends installing <a href=https://www.st.com/en/development-tools/stm32cubeide.html>STM32CubeIDE</a>, which is basically an eclipse environment with pre-installed GCC and other useful tools like <a href=http://openocd.org/>openocd</a>. I usually work without IDE, and GCC was downloaded from <a href=https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads/7-2018-q2-update>here</a></p><h2 id=kernel--u-boot--sd-image>kernel & u-boot & sd image</h2><p>I have used the default image that gets with the development kit, so everything was there and defined correctly. I will write a post on creating an adapted image for the stm32mp1, including kernel, u-boot, and file system. I also used a default application given by <a href=https://wiki.st.com/stm32mpu/index.php/Getting_started/STM32MP1_boards/STM32MP157x-EV1/Develop_on_Arm%C2%AE_Cortex%C2%AE-M4/Install_STM32Cube_MP1_package>STM32Cube_FW_MP1_V1.2.0 </a>.</p><h2 id=debug-cortex-m4>debug Cortex-M4</h2><p>The board has two modes: engineering mode where it can work on the Cortex-M4 using JTAG as it has done in any other ST microcontroller. The Cortex-M4 core will be automatically started in engineering mode once you power the board, and the Cortex-A core will not run the regular SD card boot process. This allows quickly prototyping Cortex-M4 firmware without configuring the Linux-level settings. The device boots from Cortex-A7 in the production mode and the Cortex-M4 are disabled and only can be accessed from the Linux OS. To load and activate the Cortex-M4 firmware in production mode it has to type.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>echo stop &gt; /sys/class/remoteproc/remoteproc0/state                    <span style=color:#75715e># power up Cortex-M4</span>
echo test2_CM4.elf  &gt; /sys/class/remoteproc/remoteproc0/firmware       <span style=color:#75715e># loads firmware to Cortex-M4 - it can also be done using openocd after power up of Cortex-M4</span>
echo start &gt; /sys/class/remoteproc/remoteproc0/state                   <span style=color:#75715e># power down Cortex-M4</span>
</code></pre></div><p>Refer <a href=https://wiki.st.com/stm32mpu/wiki/Linux_remoteproc_framework_overview>here</a> for more details on the remote processor framework.</p><p>if both modes the debuggeing procedure is the same using openocd:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>. /opt/st/stm32mp1/3.1-snapshot/environment-setup-cortexa7t2hf-neon-vfpv4-ostl-linux-gnueabi 
$OECORE_NATIVE_SYSROOT/usr/bin/openocd -s $OECORE_NATIVE_SYSROOT/usr/share/scripts -f board/stm32mp15x_dk2.cfg
</code></pre></div><p>Type the following to stat gdb session</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>arm-none-eabi-gdb test2_CM4.elf
</code></pre></div><p>and, In the gdb prompt command type:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>target remote 127.0.0.1:3334 <span style=color:#75715e># look at the output of the above openocd to determine the correct port to control Cortex-M4</span>
monitor soft_reset_halt
step
c
</code></pre></div><p>ST provides <a href=https://www.st.com/en/development-tools/stm32cubeide.html>IDE</a>, which based on eclipse and has all the needed facilities to support debugging with IDE. Usually, I&rsquo;m using <a href=https://cgdb.github.io/>cgdb</a>, and the following figure displays a Cortex-M4 debug session using cgdb (in the left window) and output log of Linux kernel (right window) with hello messages they were sent from the Cortext-M4 using OpenMP.</p><figure><img src=/post/hello_message_comming_from_cortex_m4.png><figcaption><h4>Linux kernel log: Hello message commining from Cortex-M4 to Cortex-A9</h4></figcaption></figure><h2 id=to-do>To do</h2><p>to display m4 logs from Linux userspace <a href=https://emcraft.com/som/stm32mp1/loading-firmware-to-the-m4-core-and-using-rpmsg-for-inter-core-communications>here</a></p><h2 id=references>References</h2><p><a href=https://visualgdb.com/tutorials/arm/stm32/stm32mp1/>[1] https://visualgdb.com/tutorials/arm/stm32/stm32mp1/</a><br><a href=https://community.st.com/s/question/0D50X0000B6QncT/debugging-m4-with-gdb-from-command-line>[2] https://community.st.com/s/question/0D50X0000B6QncT/debugging-m4-with-gdb-from-command-line</a><br><a href=https://events19.linuxfoundation.org/wp-content/uploads/2017/12/Linux-and-Zephyr-%E2%80%9CTalking%E2%80%9D-to-Each-Other-in-the-Same-SoC-Diego-Sueiro-Sepura-Embarcados.pdf>[3] https://events19.linuxfoundation.org/wp-content/uploads/2017/12/Linux-and-Zephyr-%E2%80%9CTalking%E2%80%9D-to-Each-Other-in-the-Same-SoC-Diego-Sueiro-Sepura-Embarcados.pdf</a></p></div><div class=content><div class=disqus-comments>Comments<div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"yairgd-github-io-1"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><div class="column is-3"><div class=card><div class=card-content><h1 class="title is-5">Categories</h1><div class=tags><span class=tag><a href=https://yairgd.github.io/categories/algorithm>algorithm</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/development>development</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/embedded>embedded</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/golang>golang</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/linux>linux</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/python>python</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/qt5>qt5</a></span></div></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Tags</h1><div class=tags><span class=tag><a href=https://yairgd.github.io/tags/bayer>bayer</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/computer-vision>computer-vision</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/development>development</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/eclipse>eclipse</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/embedded>embedded</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/go>go</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/golang>golang</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/hugo>hugo</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/kalman-filter>kalman-filter</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/kernel>kernel</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/linux>linux</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/opkg>opkg</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/qt5>qt5</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/rgb>rgb</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/rt>rt</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/statstical-abitrage>statstical-abitrage</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/stm32>stm32</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/templates>templates</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/themes>themes</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/yocto>yocto</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/zynq>zynq</a></span></div></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Recent posts</h1><h1><a href=https://yairgd.github.io/2020/10/simple-openamp-application-for-stm32mp157/>Simple OpenAMP application for stm32mp157</a></h1><time class="has-text-grey-light is-size-7">25 October 2020</time><h1><a href=https://yairgd.github.io/2020/10/compile-linux-kernel-for-zynq/>Compile Linux kernel for zynq</a></h1><time class="has-text-grey-light is-size-7">17 October 2020</time><h1><a href=https://yairgd.github.io/2020/09/eclipse-with-cmake-project-on-windows/>Eclipse with CMake project on windows</a></h1><time class="has-text-grey-light is-size-7">12 September 2020</time><h1><a href=https://yairgd.github.io/2020/08/install-linux-on-microzed-board/>install linux on microzed board</a></h1><time class="has-text-grey-light is-size-7">1 August 2020</time><h1><a href=https://yairgd.github.io/2020/06/custom-opkg-repository/>Custom opkg repository</a></h1><time class="has-text-grey-light is-size-7">18 June 2020</time></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Related posts</h1><h1><a href=https://yairgd.github.io/2020/10/compile-linux-kernel-for-zynq/>Compile Linux kernel for zynq</a></h1><time class="has-text-grey-light is-size-7">17 October 2020</time><h1><a href=https://yairgd.github.io/2020/08/install-linux-on-microzed-board/>install linux on microzed board</a></h1><time class="has-text-grey-light is-size-7">1 August 2020</time><h1><a href=https://yairgd.github.io/2020/06/custom-opkg-repository/>Custom opkg repository</a></h1><time class="has-text-grey-light is-size-7">18 June 2020</time><h1><a href=https://yairgd.github.io/2020/04/simple-hello-world-application-using-qt5-for-embedded-linux-device./>Simple Hello World application using qt5 for embedded Linux device.</a></h1><time class="has-text-grey-light is-size-7">1 April 2020</time><h1><a href=https://yairgd.github.io/2020/03/debug-linux-kernel-with-qemu/>Debug Linux Kernel With Qemu</a></h1><time class="has-text-grey-light is-size-7">18 March 2020</time><h1><a href=https://yairgd.github.io/2020/02/install-yocto-and-kernel-development-tools-of-imx8/>Install Yocto and kernel development tools of IMX8</a></h1><time class="has-text-grey-light is-size-7">24 February 2020</time><h1><a href=https://yairgd.github.io/2020/02/linux-uio-driver-to-handle-with-irq-source/>Linux uio driver to handle with IRQ source</a></h1><time class="has-text-grey-light is-size-7">24 February 2020</time></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Archives</h1><a href=https://yairgd.github.io/archives/2020>2020</a> (16)<br><a href=https://yairgd.github.io/archives/2014>2014</a> (4)<br></div></div></div></div></div></div><footer class="footer has-background-grey-darker has-text-white"><div class="content has-text-centered"><p><span class="icon is-large"><a href="https://m.facebook.com/yair.gadelov?ref=bookmarks" class=mysocial rel=me><i class="fab fa-facebook fa-3x"></i></a></span>&nbsp;&nbsp;
<span class="icon is-large"><a href=https://www.linkedin.com/mwlite/in/yair-gadelov-1972ab17/ class=mysocial rel=me><i class="fab fa-linkedin fa-3x"></i></a></span>&nbsp;&nbsp;
<span class="icon is-large"><a href=https://github.com/yairgd/ class=mysocial rel=me><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;<br><br>Copyright &copy; Yair Gadelov Tech Blog 2020 - Theme by <a href=https://jeffprod.com class=mysocial>JeffProd.com</a>
- <a class=mysocial href=https://yairgd.github.io/about>About</a><br></p></div></footer><script defer src=https://use.fontawesome.com/releases/v5.1.0/js/all.js></script></body></html>