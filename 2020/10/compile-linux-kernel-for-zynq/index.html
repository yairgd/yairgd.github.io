<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158845844-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-158845844-1');</script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery-cookiebar/1.0.5/jquery.cookiebar.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/jquery-cookiebar/1.0.5/jquery.cookiebar.css><script type=text/javascript>$(document).ready(function(){$.cookieBar({fixed:true,acceptOnScroll:600,policyURL:'/privacy-policy/',policyButton:true,policyText:'Privacy Policy',expireDays:45});});</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body);></script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Compile Linux kernel for zynq</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="How to build the Linux kernel for zynq in separate and not as part of the yocto build."><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css><link rel=stylesheet href=https://yairgd.github.io/css/blog.css></head><body><nav class="navbar is-fixed-top" role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=https://yairgd.github.io/>Home</a>
<a class=navbar-item href=/pages/about>About</a>
<a class=navbar-item href=/blog>Blog</a>
<a class=navbar-item href=/pages/cv>CV</a>
<a class=navbar-item href=/projects>Projects</a>
<a class=navbar-item href=/pages/search>Search</a></div></nav><section class="hero is-info is-medium"><div class=hero-body style=background-image:url(https://yairgd.github.io/img/bg-blog1.jpg)><div class="container has-text-centered"><br><h1 class="title is-size-1">Compile Linux kernel for zynq</h1></div></div></section><div class=container><div class=section><div class=columns><div class="column is-9"><div class="tile is-child box"><div class=content><article class=media><div class=media-content><div class=content><p class="title is-5"><a href=https://yairgd.github.io/2020/10/compile-linux-kernel-for-zynq/>Compile Linux kernel for zynq</a></p><p class="subtitle is-size-6 has-text-grey-light">Published at October 17, 2020 &#183;
<i class="far fa-clock"></i>&nbsp;2 min read
&#183; Tags:
<a href=https://yairgd.github.io/tags/linux/>linux</a>
<a href=https://yairgd.github.io/tags/kernel/>kernel</a>
<a href=https://yairgd.github.io/tags/yocto/>yocto</a></p></br></div></div></article><p>In previous <a href=https://yairgd.github.io/2020/08/install-linux-on-microzed-board/>post</a> I shoed how to build and install Linux system on microzed board. When one tries to modify the kernel & u-boot, it is better to build and test it separately outside the Yocto build. I use Yocto&rsquo;s kernel & u-boot sources and its SDK for the custom build.</p><h2 id=build-the-kernel>build the kernel</h2><p>To enable SDK , just type the following command.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>. /opt/poky/3.0.3/environment-setup-cortexa9t2hf-neon-poky-linux-gnueabi
</code></pre></div><p>This script will define a series of enviement variables like $CC & $CXX that needed for the build. For exmaple $CC contains the following value:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>arm-poky-linux-gnueabi-gcc -mthumb -mfpu<span style=color:#f92672>=</span>neon -mfloat-abi<span style=color:#f92672>=</span>hard -mcpu<span style=color:#f92672>=</span>cortex-a9 -fstack-protector-strong -D_FORTIFY_SOURCE<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> -Wformat -Wformat-security -Werror<span style=color:#f92672>=</span>format-security --sysroot<span style=color:#f92672>=</span>/opt/poky/3.0.3/sysroots/cortexa9t2hf-neon-poky-linux-gnueabi
</code></pre></div><p>copy the kernel sources from <em>/path/to/yocto-install/build/tmp/work-shared/microzed-zynq7/kernel-source</em> to clean the working directory and run this commands to build the kernel</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cd /path/to/kernel-source
make ARCH<span style=color:#f92672>=</span>arm  make xilinx_zynq_defconfig
make
</code></pre></div><p>To create a u-boot image (uImage file), which is a container that holds a binary file of Linux kernel, and its target memory is at address 0x8000, just run the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make -j5 UIMAGE_LOADADDR<span style=color:#f92672>=</span>0x8000 uImage
</code></pre></div><p>The kernel script <em>./scripts/Makefile.lib</em> translates this command to:</p><blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>quiet_cmd_uimage <span style=color:#f92672>=</span> UIMAGE  <span style=color:#66d9ef>$(</span>UIMAGE_OUT<span style=color:#66d9ef>)</span>
     cmd_uimage <span style=color:#f92672>=</span> <span style=color:#66d9ef>$(</span>CONFIG_SHELL<span style=color:#66d9ef>)</span> <span style=color:#66d9ef>$(</span>MKIMAGE<span style=color:#66d9ef>)</span> -A <span style=color:#66d9ef>$(</span>UIMAGE_ARCH<span style=color:#66d9ef>)</span> -O linux <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  		-C <span style=color:#66d9ef>$(</span>UIMAGE_COMPRESSION<span style=color:#66d9ef>)</span> <span style=color:#66d9ef>$(</span>UIMAGE_OPTS-y<span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  		-T <span style=color:#66d9ef>$(</span>UIMAGE_TYPE<span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  		-a <span style=color:#66d9ef>$(</span>UIMAGE_LOADADDR<span style=color:#66d9ef>)</span> -e <span style=color:#66d9ef>$(</span>UIMAGE_ENTRYADDR<span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  		-n <span style=color:#66d9ef>$(</span>UIMAGE_NAME<span style=color:#66d9ef>)</span> -d <span style=color:#66d9ef>$(</span>UIMAGE_IN<span style=color:#66d9ef>)</span> <span style=color:#66d9ef>$(</span>UIMAGE_OUT<span style=color:#66d9ef>)</span>
</code></pre></div></blockquote><p>This command uses <em>mkimgae</em> utiliety which belongs to u-boot utils and can be found under yocto build artifacts or just install u-boot-utils to linux using (gentoo):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>emerge u-boot-utils
</code></pre></div><p>In <a href=http://zedboard.org/product/minized>minized</a>, for example, there is only QSPI, so changing the file system created by Yocto and adding new modules may require some scripting work, but when using an sd card, it is easy also to build the modules and install it on the root file system.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir rootfs/boot -p
kver<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>strings arch/arm64/boot/Image | grep -i <span style=color:#e6db74>&#34;Linux version&#34;</span> | awk <span style=color:#e6db74>&#39;{print $3}&#39;</span><span style=color:#66d9ef>)</span>
sudo cp arch/arm/boot/Image.gz rootfs/boot/Image.gz-<span style=color:#e6db74>${</span>kver<span style=color:#e6db74>}</span>
sudo make ARCH<span style=color:#f92672>=</span>arm modules_install INSTALL_MOD_PATH<span style=color:#f92672>=</span>/path/to/target/root/file/system
</code></pre></div><p>After any change in the DTS file, recompile it without recompile the whole kernel.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make dtbs ARCH<span style=color:#f92672>=</span>arm
</code></pre></div><p>And again, If the board has an sd card, it easy to copy the DTS file to the target file system. If it uses QSPI, it has to prepare <a href=https://www.xilinx.com/support/documentation/sw_manuals/xilinx2018_2/ug1283-bootgen-user-guide.pdf>image</a> for QSPI.</p><h2 id=build-the-u-boot>build the u-boot</h2><p>To do</p><h2 id=references>References</h2><p><a href=https://wiki.analog.com/resources/eval/user-guides/ad-fmcomms2-ebz/software/linux/zynq_2014r2>[1] https://wiki.analog.com/resources/eval/user-guides/ad-fmcomms2-ebz/software/linux/zynq_2014r2</a></p></div><div class=content><div class=disqus-comments>Comments<div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"yairgd-github-io-1"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><div class="column is-3"><div class=card><div class=card-content><h1 class="title is-5">Categories</h1><div class=tags><span class=tag><a href=https://yairgd.github.io/categories/algorithm>algorithm</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/development>development</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/embedded>embedded</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/golang>golang</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/linux>linux</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/python>python</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/qt5>qt5</a></span></div></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Tags</h1><div class=tags><span class=tag><a href=https://yairgd.github.io/tags/bayer>bayer</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/computer-vision>computer-vision</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/cypress.>cypress.</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/development>development</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/eclipse>eclipse</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/embedded>embedded</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/go>go</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/golang>golang</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/hugo>hugo</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/kalman-filter>kalman-filter</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/kernel>kernel</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/linux>linux</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/openocd>openocd</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/opkg>opkg</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/qt5>qt5</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/rgb>rgb</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/rt>rt</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/statstical-abitrage>statstical-abitrage</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/stm32>stm32</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/templates>templates</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/themes>themes</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/yocto>yocto</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/zynq>zynq</a></span></div></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Recent posts</h1><h1><a href=https://yairgd.github.io/2020/11/debugging-of-cypress-psoc6-in-linux-terminal./>Debugging of cypress psoc6 in Linux terminal.</a></h1><time class="has-text-grey-light is-size-7">5 November 2020</time><h1><a href=https://yairgd.github.io/2020/10/simple-openamp-application-for-stm32mp157/>Simple OpenAMP application for stm32mp157</a></h1><time class="has-text-grey-light is-size-7">25 October 2020</time><h1><a href=https://yairgd.github.io/2020/10/compile-linux-kernel-for-zynq/>Compile Linux kernel for zynq</a></h1><time class="has-text-grey-light is-size-7">17 October 2020</time><h1><a href=https://yairgd.github.io/2020/09/eclipse-with-cmake-project-on-windows/>Eclipse with CMake project on windows</a></h1><time class="has-text-grey-light is-size-7">12 September 2020</time><h1><a href=https://yairgd.github.io/2020/08/install-linux-on-microzed-board/>install linux on microzed board</a></h1><time class="has-text-grey-light is-size-7">1 August 2020</time></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Related posts</h1><h1><a href=https://yairgd.github.io/2020/10/simple-openamp-application-for-stm32mp157/>Simple OpenAMP application for stm32mp157</a></h1><time class="has-text-grey-light is-size-7">25 October 2020</time><h1><a href=https://yairgd.github.io/2020/08/install-linux-on-microzed-board/>install linux on microzed board</a></h1><time class="has-text-grey-light is-size-7">1 August 2020</time><h1><a href=https://yairgd.github.io/2020/06/custom-opkg-repository/>Custom opkg repository</a></h1><time class="has-text-grey-light is-size-7">18 June 2020</time><h1><a href=https://yairgd.github.io/2020/04/simple-hello-world-application-using-qt5-for-embedded-linux-device./>Simple Hello World application using qt5 for embedded Linux device.</a></h1><time class="has-text-grey-light is-size-7">1 April 2020</time><h1><a href=https://yairgd.github.io/2020/03/debug-linux-kernel-with-qemu/>Debug Linux Kernel With Qemu</a></h1><time class="has-text-grey-light is-size-7">18 March 2020</time><h1><a href=https://yairgd.github.io/2020/02/install-yocto-and-kernel-development-tools-of-imx8/>Install Yocto and kernel development tools of IMX8</a></h1><time class="has-text-grey-light is-size-7">24 February 2020</time><h1><a href=https://yairgd.github.io/2020/02/linux-uio-driver-to-handle-with-irq-source./>Linux UIO driver to handle with IRQ source.</a></h1><time class="has-text-grey-light is-size-7">24 February 2020</time></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Archives</h1><a href=https://yairgd.github.io/archives/2020>2020</a> (17)<br><a href=https://yairgd.github.io/archives/2014>2014</a> (4)<br></div></div></div></div></div></div><footer class="footer has-background-grey-darker has-text-white"><div class="content has-text-centered"><p><span class="icon is-large"><a href="https://m.facebook.com/yair.gadelov?ref=bookmarks" class=mysocial rel=me><i class="fab fa-facebook fa-3x"></i></a></span>&nbsp;&nbsp;
<span class="icon is-large"><a href=https://www.linkedin.com/mwlite/in/yair-gadelov-1972ab17/ class=mysocial rel=me><i class="fab fa-linkedin fa-3x"></i></a></span>&nbsp;&nbsp;
<span class="icon is-large"><a href=https://github.com/yairgd/ class=mysocial rel=me><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;<br><br>Copyright &copy; Yair Gadelov Tech Blog 2020 - Theme by <a href=https://jeffprod.com class=mysocial>JeffProd.com</a>
- <a class=mysocial href=https://yairgd.github.io/about>About</a><br></p></div></footer><script defer src=https://use.fontawesome.com/releases/v5.1.0/js/all.js></script></body></html>