<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158845844-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-158845844-1');</script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery-cookiebar/1.0.5/jquery.cookiebar.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/jquery-cookiebar/1.0.5/jquery.cookiebar.css><script type=text/javascript>$(document).ready(function(){$.cookieBar({fixed:true,acceptOnScroll:600,policyURL:'/privacy-policy/',policyButton:true,policyText:'Privacy Policy',expireDays:45});});</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body);></script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Linux module magic info</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Linux module magic info"><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css><link rel=stylesheet href=https://yairgd.github.io/css/blog.css></head><body><nav class="navbar is-fixed-top" role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=https://yairgd.github.io/>Home</a>
<a class=navbar-item href=/pages/about>About</a>
<a class=navbar-item href=/blog>Blog</a>
<a class=navbar-item href=/pages/cv>CV</a>
<a class=navbar-item href=/projects>Projects</a>
<a class=navbar-item href=/pages/search>Search</a></div></nav><section class="hero is-info is-medium"><div class=hero-body style=background-image:url(https://yairgd.github.io/img/bg-blog1.jpg)><div class="container has-text-centered"><br><h1 class="title is-size-1">Linux module magic info</h1></div></div></section><div class=container><div class=section><div class=columns><div class="column is-9"><div class="tile is-child box"><div class=content><article class=media><div class=media-content><div class=content><p class="title is-5"><a href=https://yairgd.github.io/2020/02/linux-module-magic-info/>Linux module magic info</a></p><p class="subtitle is-size-6 has-text-grey-light">Published at February 20, 2020 &#183;
<i class="far fa-clock"></i>&nbsp;3 min read
&#183; Tags:
<a href=https://yairgd.github.io/tags/linux/>linux</a>
<a href=https://yairgd.github.io/tags/kernel/>kernel</a>
<a href=https://yairgd.github.io/tags/rt/>rt</a></p></br></div></div></article><p>Sometimes we want to build a module separate from the kernel. When the kernel is built, it generates a magic number, which probably depends on compiler version, kernel version, git source revision, etc. Time is also probably part of this magic number, since the kernel may build with the same parameters but with a different timestamp, it will have a different magic number, and then we will get this message when we try to insert it:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>root@linux:~# insmod /lib/modules/4.14.78-imx8m+g7808f06d8af2/extra/hello.ko
insmod: ERROR: could not insert module /lib/modules/4.14.78-imx8m+g7808f06d8af2/extra/hello.ko: Invalid module format
</code></pre></div><h2 id=recompile-module>recompile module</h2><p>just got to this file and change UTS_RELEASE:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cat ./include/generated/utsrelease.h
<span style=color:#75715e>#define UTS_RELEASE &#34;4.14.78-g8e54a4b719e6&#34;</span>
</code></pre></div><h2 id=module-that-we-cannot-recompile>module that we cannot recompile</h2><p>To handle this situation without installing a new kernel + modules, we will replace the module magic number. This not work for some reason that I don&rsquo;t understand. The easy and the right way is to change the <em>utsrelease.h</em> file explained above. I&rsquo;m sure that what I&rsquo;m doing here is correct, but since I already start to investigate it, I will keep it here for sometime else.</p><p>The kernel version can be achieved form this command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$strings arch/arm64/boot/Image | grep -i <span style=color:#e6db74>&#34;Linux version&#34;</span> 
Linux version 4.14.78-g8e54a4b719e6 <span style=color:#f92672>(</span>yair@yair<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>gcc version 7.3.0 <span style=color:#f92672>(</span>GCC<span style=color:#f92672>)</span><span style=color:#f92672>)</span> <span style=color:#75715e>#1 SMP PREEMPT Tue Oct 22 11:54:22 IDT 2019</span>
</code></pre></div><p>and the module version is archive from :</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>modinfo -F vermagic hello.ko
</code></pre></div><p>The full modinfo section can be displayed by:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ objdump -s -j .modinfo hello.ko

hello.ko:     file format elf64-little

Contents of section .modinfo:
 <span style=color:#ae81ff>0000</span> 6c696365 6e73653d 47504c00 <span style=color:#ae81ff>00000000</span>  license<span style=color:#f92672>=</span>GPL.....
 <span style=color:#ae81ff>0010</span> <span style=color:#ae81ff>64657065</span> 6e64733d 006e616d 653d6865  depends<span style=color:#f92672>=</span>.name<span style=color:#f92672>=</span>he
 <span style=color:#ae81ff>0020</span> 6c6c6f00 7665726d <span style=color:#ae81ff>61676963</span> 3d342e31  llo.vermagic<span style=color:#f92672>=</span>4.1
 <span style=color:#ae81ff>0030</span> 342e3738 2d673865 <span style=color:#ae81ff>35346134</span> <span style=color:#ae81ff>62373139</span>  4.78-g8e54a4b719
 <span style=color:#ae81ff>0040</span> <span style=color:#ae81ff>65362053</span> 4d502070 7265656d 7074206d  e6 SMP preempt m
 <span style=color:#ae81ff>0050</span> 6f645f75 6e6c6f61 <span style=color:#ae81ff>64206161</span> <span style=color:#ae81ff>72636836</span>  od_unload aarch6
 <span style=color:#ae81ff>0060</span> <span style=color:#ae81ff>3400</span>
</code></pre></div><p>To get the module magic number run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ modinfo hello.ko
filename:       hello.ko
license:        GPL
depends:        
name:           hello
vermagic:       4.14.78-g8e54a4b719e6 SMP preempt mod_unload aarch64
</code></pre></div><p>copy the modinfo section to a file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>export OBJCOPY<span style=color:#f92672>=</span>/opt/fsl-imx-xwayland/4.14-sumo/sysroots/x86_64-pokysdk-linux/usr/bin/aarch64-poky-linux/aarch64-poky-linux-objcopy
$OBJCOPY  ./hello.ko  /dev/null --dump-section .modinfo<span style=color:#f92672>=</span>mod_info
</code></pre></div><p>update the magic number</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sed  <span style=color:#e6db74>&#39;s/4.14.78-g8e54a4b719e6/4.14.78+g7808f06d8af2/g&#39;</span> -i mod_info
</code></pre></div><p>update the module</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ $OBJCOPY --remove-section<span style=color:#f92672>=</span>.modinfo --add-section .modinfo<span style=color:#f92672>=</span>mod_info  hello.ko
</code></pre></div><p>test for the new magic number</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$  modinfo hello.ko
filename:       hello.ko
license:        GPL
depends:        
name:           hello
vermagic:       4.14.78+g7808f06d8af2 SMP preempt mod_unload aarch64
</code></pre></div><h3 id=related-issues>Related issues</h3><p>example of two related issues:</p><ul><li><p>See <a href=https://archives.gentoo.org/gentoo-user/message/3d188075a832cf3ab3926abcf6c7413b>here</a> for a bug report which relates to this issue. The problem there was that the file <em>./include/generated/utsrelease.h</em> did not exist. To fix, it only has to recompile the kernel.</p></li><li><p>Fail during the compilation of <em>sys-kernel/spl-0.7.13</em> at Gentoo system. Again, in this case, just need to build the kernel and make <em>/usr/src/linux</em> points to it.</p></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>checking spl config... all
checking kernel source directory... /usr/src/linux
checking kernel build directory... /usr/src/linux
checking kernel source version... Not found
configure: error: *** Cannot find UTS_RELEASE definition.

!!! Please attach the following file when seeking support:
!!! /var/tmp/portage/sys-kernel/spl-0.7.13/work/spl-0.7.13/config.log
 * ERROR: sys-kernel/spl-0.7.13::gentoo failed <span style=color:#f92672>(</span>configure phase<span style=color:#f92672>)</span>:
 *   econf failed
 * 
 * Call stack:
 *               ebuild.sh, line  125:  Called src_configure
 *             environment, line 4738:  Called autotools-utils_src_configure
 *             environment, line  934:  Called econf <span style=color:#e6db74>&#39;--docdir=/usr/share/doc/spl-0.7.13&#39;</span> <span style=color:#e6db74>&#39;--bindir=/bin&#39;</span> <span style=color:#e6db74>&#39;--sbindir=/sbin&#39;</span> <span style=color:#e6db74>&#39;--with-config=all&#39;</span> <span style=color:#e6db74>&#39;--with-linux=/usr/src/linux&#39;</span> <span style=color:#e6db74>&#39;--with-linux-obj=/usr/src/linux&#39;</span> <span style=color:#e6db74>&#39;--disable-debug&#39;</span>
 *        phase-helpers.sh, line  681:  Called __helpers_die <span style=color:#e6db74>&#39;econf failed&#39;</span>
 *   isolated-functions.sh, line  112:  Called die
 * The specific snippet of code:
 *           die <span style=color:#e6db74>&#34;</span>$@<span style=color:#e6db74>&#34;</span>
 * 
 * If you need support, post the output of <span style=color:#e6db74>`</span>emerge --info <span style=color:#e6db74>&#39;=sys-kernel/spl-0.7.13::gentoo&#39;</span><span style=color:#e6db74>`</span>,
 * the complete build log and the output of <span style=color:#e6db74>`</span>emerge -pqv <span style=color:#e6db74>&#39;=sys-kernel/spl-0.7.13::gentoo&#39;</span><span style=color:#e6db74>`</span>.
 * The complete build log is located at <span style=color:#e6db74>&#39;/var/tmp/portage/sys-kernel/spl-0.7.13/temp/build.log&#39;</span>.
 * The ebuild environment file is located at <span style=color:#e6db74>&#39;/var/tmp/portage/sys-kernel/spl-0.7.13/temp/environment&#39;</span>.
 * Working directory: <span style=color:#e6db74>&#39;/var/tmp/portage/sys-kernel/spl-0.7.13/work/spl-0.7.13&#39;</span>
 * S: <span style=color:#e6db74>&#39;/var/tmp/portage/sys-kernel/spl-0.7.13/work/spl-0.7.13&#39;</span>
</code></pre></div><h2 id=reference>reference</h2><p><a href=https://www.linuxquestions.org/questions/linux-kernel-70/how-to-change-the-vermagic-of-a-module-728387/>[1] How to change the vermagic of a module</a></p></div><div class=content><div class=disqus-comments>Comments<div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"yairgd-github-io-1"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><div class="column is-3"><div class=card><div class=card-content><h1 class="title is-5">Categories</h1><div class=tags><span class=tag><a href=https://yairgd.github.io/categories/algorithm>algorithm</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/development>development</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/embedded>embedded</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/golang>golang</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/linux>linux</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/python>python</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/qt5>qt5</a></span></div></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Tags</h1><div class=tags><span class=tag><a href=https://yairgd.github.io/tags/bayer>bayer</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/computer-vision>computer-vision</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/cypress.>cypress.</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/development>development</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/eclipse>eclipse</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/embedded>embedded</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/go>go</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/golang>golang</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/hugo>hugo</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/kalman-filter>kalman-filter</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/kernel>kernel</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/linux>linux</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/openocd>openocd</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/opkg>opkg</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/qt5>qt5</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/rgb>rgb</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/rt>rt</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/statstical-abitrage>statstical-abitrage</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/stm32>stm32</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/templates>templates</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/themes>themes</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/usb>usb</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/yocto>yocto</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/zynq>zynq</a></span></div></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Recent posts</h1><h1><a href=https://yairgd.github.io/2021/01/linux-gadget-device/>Linux Gadget Device</a></h1><time class="has-text-grey-light is-size-7">19 January 2021</time><h1><a href=https://yairgd.github.io/2020/11/install-embedded-linux-toolchain-on-windows/>Install embedded Linux toolchain on windows</a></h1><time class="has-text-grey-light is-size-7">25 November 2020</time><h1><a href=https://yairgd.github.io/2020/11/debugging-of-cypress-psoc6-in-linux-terminal./>Debugging of cypress psoc6 in Linux terminal.</a></h1><time class="has-text-grey-light is-size-7">5 November 2020</time><h1><a href=https://yairgd.github.io/2020/10/simple-openamp-application-for-stm32mp157/>Simple OpenAMP application for stm32mp157</a></h1><time class="has-text-grey-light is-size-7">25 October 2020</time><h1><a href=https://yairgd.github.io/2020/10/compile-linux-kernel-for-zynq/>Compile Linux kernel for zynq</a></h1><time class="has-text-grey-light is-size-7">17 October 2020</time></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Related posts</h1><h1><a href=https://yairgd.github.io/2021/01/linux-gadget-device/>Linux Gadget Device</a></h1><time class="has-text-grey-light is-size-7">19 January 2021</time><h1><a href=https://yairgd.github.io/2020/11/install-embedded-linux-toolchain-on-windows/>Install embedded Linux toolchain on windows</a></h1><time class="has-text-grey-light is-size-7">25 November 2020</time><h1><a href=https://yairgd.github.io/2020/10/simple-openamp-application-for-stm32mp157/>Simple OpenAMP application for stm32mp157</a></h1><time class="has-text-grey-light is-size-7">25 October 2020</time><h1><a href=https://yairgd.github.io/2020/10/compile-linux-kernel-for-zynq/>Compile Linux kernel for zynq</a></h1><time class="has-text-grey-light is-size-7">17 October 2020</time><h1><a href=https://yairgd.github.io/2020/04/simple-hello-world-application-using-qt5-for-embedded-linux-device./>Simple Hello World application using qt5 for embedded Linux device.</a></h1><time class="has-text-grey-light is-size-7">1 April 2020</time><h1><a href=https://yairgd.github.io/2020/03/debug-linux-kernel-with-qemu/>Debug Linux Kernel With Qemu</a></h1><time class="has-text-grey-light is-size-7">18 March 2020</time><h1><a href=https://yairgd.github.io/2020/02/install-yocto-and-kernel-development-tools-of-imx8/>Install Yocto and kernel development tools of IMX8</a></h1><time class="has-text-grey-light is-size-7">24 February 2020</time></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Archives</h1><a href=https://yairgd.github.io/archives/2021>2021</a> (1)<br><a href=https://yairgd.github.io/archives/2020>2020</a> (18)<br><a href=https://yairgd.github.io/archives/2014>2014</a> (4)<br></div></div></div></div></div></div><footer class="footer has-background-grey-darker has-text-white"><div class="content has-text-centered"><p><span class="icon is-large"><a href="https://m.facebook.com/yair.gadelov?ref=bookmarks" class=mysocial rel=me><i class="fab fa-facebook fa-3x"></i></a></span>&nbsp;&nbsp;
<span class="icon is-large"><a href=https://www.linkedin.com/mwlite/in/yair-gadelov-1972ab17/ class=mysocial rel=me><i class="fab fa-linkedin fa-3x"></i></a></span>&nbsp;&nbsp;
<span class="icon is-large"><a href=https://github.com/yairgd/ class=mysocial rel=me><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;<br><br>Copyright &copy; Yair Gadelov Tech Blog 2021 - Theme by <a href=https://jeffprod.com class=mysocial>JeffProd.com</a>
- <a class=mysocial href=https://yairgd.github.io/about>About</a><br></p></div></footer><script defer src=https://use.fontawesome.com/releases/v5.1.0/js/all.js></script></body></html>