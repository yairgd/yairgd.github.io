<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158845844-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-158845844-1');</script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery-cookiebar/1.0.5/jquery.cookiebar.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/jquery-cookiebar/1.0.5/jquery.cookiebar.css><script type=text/javascript>$(document).ready(function(){$.cookieBar({fixed:true,acceptOnScroll:600,policyURL:'/privacy-policy/',policyButton:true,policyText:'Privacy Policy',expireDays:45});});</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body);></script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Linux module to disassemble code in the Linux kernel.</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Linux module to disassemble code in the Linux kernel."><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css><link rel=stylesheet href=https://yairgd.github.io/css/blog.css></head><body><nav class="navbar is-fixed-top" role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=https://yairgd.github.io/>Home</a>
<a class=navbar-item href=/pages/about>About</a>
<a class=navbar-item href=/blog>Blog</a>
<a class=navbar-item href=/pages/cv>CV</a>
<a class=navbar-item href=/projects>Projects</a>
<a class=navbar-item href=/pages/search>Search</a></div></nav><section class="hero is-info is-medium"><div class=hero-body style=background-image:url(https://yairgd.github.io/img/bg-blog1.jpg)><div class="container has-text-centered"><br><h1 class="title is-size-1">Linux module to disassemble code in the Linux kernel.</h1></div></div></section><div class=container><div class=section><div class=columns><div class="column is-9"><div class="tile is-child box"><div class=content><article class=media><div class=media-content><div class=content><p class="title is-5"><a href=https://yairgd.github.io/2020/02/linux-module-to-disassemble-code-in-the-linux-kernel./>Linux module to disassemble code in the Linux kernel.</a></p><p class="subtitle is-size-6 has-text-grey-light">Published at February 18, 2020 &#183;
<i class="far fa-clock"></i>&nbsp;3 min read
&#183; Tags:
<a href=https://yairgd.github.io/tags/linux/>linux</a>
<a href=https://yairgd.github.io/tags/kernel/>kernel</a></p></br></div></div></article><p>A simple module to disassembly memory using a Linux kernel module. This module is based on <a href=https://github.com/zyantific/zydis>Zydis</a> and integrated into this module. Also, there is a userspace application to demonstrate the Zydis library on a test function in user space and disassembly of the same c function at the kernel space. Also can dissemble internal c functions of the kernel like printk, kmalloc etc&rsquo;.</p><h2 id=module-structure>Module structure</h2><p>The module allows two interfaces from userspace:</p><ul><li><p>Using kernel parameters API:
This part of the module demonstrates the use of module parameters API to control the module. There is one parameter named <em>func</em> and it uses to select from userspace the internal function to disassemble.</p></li><li><p>Using kernel char device API (using a misc device):
The purpose of this interface is to make a file behavior for the disa module using <em>/dev/disa</em> using file system calls open, read,ioctl, and its content is the disassembly text code of a selected function. The selected function can be one of two:</p><ol><li>Internal kennel function (see kernel parameter <em>func</em>)</li><li>The local function of a process and it set using ioctl system call.</li></ol></li></ul><h2 id=build-the-module>Build the module</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git clone https://github.com/yairgd/disa.git
cd disa
make 
</code></pre></div><h2 id=testing-the-module>Testing the module</h2><p>Run test1,test2.py are unit tests for this module and to load into the kernel use this command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo insmod module/disa.ko
sudo ./test1
sudo ./test2.py
</code></pre></div><h2 id=testing-of-disassembly-of-userspace-function>Testing of disassembly of userspace function</h2><p>Compare between the output of test1 function that disassembles func1 (see test1.c) on userspace and in the kernel space using disa module. Here is the output of test1 in userspace:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>this <span style=color:#66d9ef>function</span>  named <span style=color:#e6db74>&#34;func1&#34;</span> with param <span style=color:#ae81ff>123</span>
push rbp
mov rbp, rsp
sub rsp, 0x10
mov <span style=color:#f92672>[</span>rbp-0x04<span style=color:#f92672>]</span>, edi
mov eax, <span style=color:#f92672>[</span>rbp-0x04<span style=color:#f92672>]</span>
mov edx, eax
lea rsi, <span style=color:#f92672>[</span>0x000055EE2B1475D5<span style=color:#f92672>]</span>
</code></pre></div><p>and the same disasebly in kernel space:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>push rbp
mov rbp, rsp
sub rsp, 0x10
mov <span style=color:#f92672>[</span>rbp-0x04<span style=color:#f92672>]</span>, edi
mov eax, <span style=color:#f92672>[</span>rbp-0x04<span style=color:#f92672>]</span>
mov edx, eax
lea rsi, <span style=color:#f92672>[</span>0x000055F50A1455D5<span style=color:#f92672>]</span>
</code></pre></div><p>Both results are identical with gdb:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>  <span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/10i func1
   0x555555563aba &lt;func1&gt;:      push   %rbp
   0x555555563abb &lt;func1+1&gt;:    mov    %rsp,%rbp
   0x555555563abe &lt;func1+4&gt;:    sub    $0x10,%rsp
   0x555555563ac2 &lt;func1+8&gt;:    mov    %edi,-0x4<span style=color:#f92672>(</span>%rbp<span style=color:#f92672>)</span>
   0x555555563ac5 &lt;func1+11&gt;:   mov    -0x4<span style=color:#f92672>(</span>%rbp<span style=color:#f92672>)</span>,%eax
   0x555555563ac8 &lt;func1+14&gt;:   mov    %eax,%edx
   0x555555563aca &lt;func1+16&gt;:   lea    0x17b04<span style=color:#f92672>(</span>%rip<span style=color:#f92672>)</span>,%rsi        <span style=color:#75715e># 0x55555557b5d5 &lt;__FUNCTION__.3489&gt;</span>  
</code></pre></div><p>and func1 eauls to :</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>p/u <span style=color:#f92672>(</span>void*<span style=color:#f92672>)</span>func1
$14 <span style=color:#f92672>=</span> <span style=color:#ae81ff>93824992295610</span>
</code></pre></div><p>and the addr parameter also equals to it:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat /sys/module/disasm/parameters/addr 
<span style=color:#ae81ff>93824992295610</span>
</code></pre></div><h2 id=testing-of-disasbly-internal-kernel-function>Testing of disasbly internal kernel function</h2><p>Use this command to get list of inernal functions that module is able to disasebmly.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo su -c <span style=color:#e6db74>&#39;/sys/module/disasm/parameters/func&#39;</span>
</code></pre></div><p>Here is a pyhton code to use when its required to disasmble the code of <em>kfree</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># select intenal function to disasembly  </span>
f <span style=color:#f92672>=</span> open(<span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>/sys/module/disasm/parameters/func</span><span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>w</span><span style=color:#e6db74>&#34;</span>);
f<span style=color:#f92672>.</span>write(<span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>kfree</span><span style=color:#e6db74>&#34;</span>);
f<span style=color:#f92672>.</span>close();
<span style=color:#75715e># read the disasmbly data as file</span>
f<span style=color:#f92672>=</span>open(<span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>/dev/disa</span><span style=color:#e6db74>&#34;</span>,<span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;</span>);
a <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>256</span>);
a <span style=color:#f92672>=</span> a<span style=color:#f92672>.</span>replace(<span style=color:#e6db74></span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>;</span><span style=color:#e6db74>&#39;</span>,<span style=color:#e6db74></span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>);
<span style=color:#66d9ef>print</span> ( a);
f<span style=color:#f92672>.</span>close();
</code></pre></div><p>And the result is:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>push rbp
mov rbp, rsp
push r13
push r12
mov r13, <span style=color:#f92672>[</span>rbp+0x08<span style=color:#f92672>]</span>
push rbx
mov rbx, rdi
nop
cmp rbx, 0x10
jbe 0xFFFFFFFF8117C71D
mov r10d, 0x80000000
mov rax, 0x77FF80000000
mov rdi, 0xFFFFEA0000000000
add r10, rbx
cmovb rax, <span style=color:#f92672>[</span>0xFFFFFFFF81E0D010<span style=color:#f92672>]</span>
add r10, rax
</code></pre></div><p>To use the module in bash command line type:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo cat /dev/disa | sed -e <span style=color:#e6db74>$&#39;s/;/\\\n/g&#39;</span>
</code></pre></div><h2 id=references>References</h2><p>Here are some reference sources that used to create this module
<a href=http://www.embeddedlinux.org.cn/essentiallinuxdevicedrivers/final/ch05lev1sec7.html>http://www.embeddedlinux.org.cn/essentiallinuxdevicedrivers/final/ch05lev1sec7.html</a>
<a href=http://olegkutkov.me/2018/03/14/simple-linux-character-device-driver/>http://olegkutkov.me/2018/03/14/simple-linux-character-device-driver/</a>
<a href=https://linux-kernel-labs.github.io/master/labs/device_drivers.html>https://linux-kernel-labs.github.io/master/labs/device_drivers.html</a>
<a href=https://gist.github.com/brenns10/65d1ee6bb8419f96d2ae693eb7a66cc0>https://gist.github.com/brenns10/65d1ee6bb8419f96d2ae693eb7a66cc0</a>
<a href=https://www.kernel.org/doc/htmldocs/kernel-hacking/routines-module-use-counters.html>https://www.kernel.org/doc/htmldocs/kernel-hacking/routines-module-use-counters.html</a>
<a href=https://stackoverflow.com/questions/18456155/what-is-the-difference-between-misc-drivers-and-char-drivers>https://stackoverflow.com/questions/18456155/what-is-the-difference-between-misc-drivers-and-char-drivers</a></p></div><div class=content><div class=disqus-comments>Comments<div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"yairgd-github-io-1"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><div class="column is-3"><div class=card><div class=card-content><h1 class="title is-5">Categories</h1><div class=tags><span class=tag><a href=https://yairgd.github.io/categories/algorithm>algorithm</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/development>development</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/embedded>embedded</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/golang>golang</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/linux>linux</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/python>python</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/qt5>qt5</a></span></div></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Tags</h1><div class=tags><span class=tag><a href=https://yairgd.github.io/tags/bayer>bayer</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/computer-vision>computer-vision</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/development>development</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/eclipse>eclipse</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/embedded>embedded</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/go>go</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/golang>golang</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/hugo>hugo</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/kalman-filter>kalman-filter</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/kernel>kernel</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/linux>linux</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/opkg>opkg</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/qt5>qt5</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/rgb>rgb</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/rt>rt</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/statstical-abitrage>statstical-abitrage</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/templates>templates</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/themes>themes</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/yocto>yocto</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/zynq>zynq</a></span></div></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Recent posts</h1><h1><a href=https://yairgd.github.io/2020/10/compile-linux-kernel-for-zynq/>Compile Linux kernel for zynq</a></h1><time class="has-text-grey-light is-size-7">17 October 2020</time><h1><a href=https://yairgd.github.io/2020/09/eclipse-with-cmake-project-on-windows/>Eclipse with CMake project on windows</a></h1><time class="has-text-grey-light is-size-7">12 September 2020</time><h1><a href=https://yairgd.github.io/2020/08/install-linux-on-microzed-board/>install linux on microzed board</a></h1><time class="has-text-grey-light is-size-7">1 August 2020</time><h1><a href=https://yairgd.github.io/2020/06/custom-opkg-repository/>Custom opkg repository</a></h1><time class="has-text-grey-light is-size-7">18 June 2020</time><h1><a href=https://yairgd.github.io/2020/05/kalman-filter-and-pair-trading/>Kalman filter and pair trading</a></h1><time class="has-text-grey-light is-size-7">1 May 2020</time></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Related posts</h1><h1><a href=https://yairgd.github.io/2020/10/compile-linux-kernel-for-zynq/>Compile Linux kernel for zynq</a></h1><time class="has-text-grey-light is-size-7">17 October 2020</time><h1><a href=https://yairgd.github.io/2020/04/simple-hello-world-application-using-qt5-for-embedded-linux-device./>Simple Hello World application using qt5 for embedded Linux device.</a></h1><time class="has-text-grey-light is-size-7">1 April 2020</time><h1><a href=https://yairgd.github.io/2020/03/debug-linux-kernel-with-qemu/>Debug Linux Kernel With Qemu</a></h1><time class="has-text-grey-light is-size-7">18 March 2020</time><h1><a href=https://yairgd.github.io/2020/02/install-yocto-and-kernel-development-tools-of-imx8/>Install Yocto and kernel development tools of IMX8</a></h1><time class="has-text-grey-light is-size-7">24 February 2020</time><h1><a href=https://yairgd.github.io/2020/02/linux-uio-driver-to-handle-with-irq-source/>Linux uio driver to handle with IRQ source</a></h1><time class="has-text-grey-light is-size-7">24 February 2020</time><h1><a href=https://yairgd.github.io/2020/02/linux-char-device-to-handle-with-irq/>Linux char device to handle with IRQ</a></h1><time class="has-text-grey-light is-size-7">20 February 2020</time><h1><a href=https://yairgd.github.io/2020/02/linux-module-magic-info/>Linux module magic info</a></h1><time class="has-text-grey-light is-size-7">20 February 2020</time></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Archives</h1><a href=https://yairgd.github.io/archives/2020>2020</a> (15)<br><a href=https://yairgd.github.io/archives/2014>2014</a> (4)<br></div></div></div></div></div></div><footer class="footer has-background-grey-darker has-text-white"><div class="content has-text-centered"><p><span class="icon is-large"><a href="https://m.facebook.com/yair.gadelov?ref=bookmarks" class=mysocial rel=me><i class="fab fa-facebook fa-3x"></i></a></span>&nbsp;&nbsp;
<span class="icon is-large"><a href=https://www.linkedin.com/mwlite/in/yair-gadelov-1972ab17/ class=mysocial rel=me><i class="fab fa-linkedin fa-3x"></i></a></span>&nbsp;&nbsp;
<span class="icon is-large"><a href=https://github.com/yairgd/ class=mysocial rel=me><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;<br><br>Copyright &copy; Yair Gadelov Tech Blog 2020 - Theme by <a href=https://jeffprod.com class=mysocial>JeffProd.com</a>
- <a class=mysocial href=https://yairgd.github.io/about>About</a><br></p></div></footer><script defer src=https://use.fontawesome.com/releases/v5.1.0/js/all.js></script></body></html>