<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158845844-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-158845844-1');</script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery-cookiebar/1.0.5/jquery.cookiebar.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/jquery-cookiebar/1.0.5/jquery.cookiebar.css><script type=text/javascript>$(document).ready(function(){$.cookieBar({fixed:true,acceptOnScroll:600,policyURL:'/privacy-policy/',policyButton:true,policyText:'Privacy Policy',expireDays:45});});</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body);></script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Kalman filter and pair trading</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Implemantion of kalman filter for  statistical arbitrage purpose"><link href="https://fonts.googleapis.com/css?family=Open+Sans" rel=stylesheet><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css><link rel=stylesheet href=https://yairgd.github.io/css/blog.css></head><body><nav class="navbar is-fixed-top" role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=https://yairgd.github.io/>Home</a>
<a class=navbar-item href=/pages/about>About</a>
<a class=navbar-item href=/blog>Blog</a>
<a class=navbar-item href=/pages/cv>CV</a>
<a class=navbar-item href=/projects>Projects</a>
<a class=navbar-item href=/pages/search>Search</a></div></nav><section class="hero is-info is-medium"><div class=hero-body style=background-image:url(https://yairgd.github.io/img/bg-blog1.jpg)><div class="container has-text-centered"><br><h1 class="title is-size-1">Kalman filter and pair trading</h1></div></div></section><div class=container><div class=section><div class=columns><div class="column is-9"><div class="tile is-child box"><div class=content><article class=media><div class=media-content><div class=content><p class="title is-5"><a href=https://yairgd.github.io/2020/05/kalman-filter-and-pair-trading/>Kalman filter and pair trading</a></p><p class="subtitle is-size-6 has-text-grey-light">Published at May 1, 2020 &#183;
<i class="far fa-clock"></i>&nbsp;4 min read
&#183; Tags:
<a href=https://yairgd.github.io/tags/kalman-filter/>kalman-filter</a>
<a href=https://yairgd.github.io/tags/statstical-abitrage/>statstical abitrage</a></p></br></div></div></article><p>Pair trading is a type of cointegration approach to statistical arbitrage trading strategy in which usually a pair of stocks are tcraded in a market-neutral strategy, i.e. it doesnâ€™t matter whether the market is trending upwards or downwards, the two open positions for each stock hedge against each other. The key challenges in pairs trading are to:</p><ul><li>Choose a pair which will give you good statistical arbitrage opportunities over time</li><li>Choose the entry/exit points</li></ul><p>One of the challenges with the pair trading is that cointegration relationships are seldom static. I implemented a Kalman filter to track changes in this relationship between the stocks with synthesized stocks data.</p><h2 id=data-sythesis>data sythesis</h2><p>These are some initil paramaters for octabe/matlab simulation:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-matlab data-lang=matlab>mu=<span style=color:#ae81ff>0.1</span>;
t=<span style=color:#ae81ff>1</span>:<span style=color:#ae81ff>1000</span>;
sig=<span style=color:#ae81ff>0.3</span>;
T=<span style=color:#ae81ff>1</span>;
N=<span style=color:#ae81ff>1000</span>;
r=mu<span style=color:#f92672>-</span>sig^<span style=color:#ae81ff>2</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>;
Y=randn;
h=T<span style=color:#f92672>/</span>N;
sh=sqrt(h);
mh=r<span style=color:#f92672>*</span>h;
x0=<span style=color:#ae81ff>100</span>;
</code></pre></div><p>I have used the simplest form to model the relationship between a pair of securities in the following way:<div style=overflow:auto;width:auto>$$
\beta(t) = \beta(t-1) + \omega\\
\omega \sim N(0,Q)\\
$$</div>where beta is the unobserved state variable that follows a random walk, and W is a Gaussian distributed process with men 0 standard deviation Q.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-matlab data-lang=matlab>R=sqrt (<span style=color:#ae81ff>0.001</span>);
Q=sqrt(<span style=color:#ae81ff>0.00001</span>);
beta=<span style=color:#ae81ff>1</span><span style=color:#f92672>+</span>cumsum (Q<span style=color:#f92672>*</span>randn(size(t)));
</code></pre></div><figure><img src=/post/kalman_filter_and_stat_arbitrage/beta.png><figcaption><h4>Raw Bayer Image</h4></figcaption></figure><p>The observed processes of stock prices Y(t) and X(t) and V is gaussion disribued process with men 0 standard deviation R.<div style=overflow:auto;width:auto>$$
Y(t)=\beta(t)X(t)+v \\
v \sim N(0,R)\\
$$</div></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-matlab data-lang=matlab>clear G
X=x0;
G(:,<span style=color:#ae81ff>1</span>)=[<span style=color:#ae81ff>0</span> x0];
<span style=color:#66d9ef>for</span> j=<span style=color:#ae81ff>2</span>:N
	z=randn;
	X=X<span style=color:#f92672>*</span>exp(mh<span style=color:#f92672>+</span>sh<span style=color:#f92672>*</span>sig<span style=color:#f92672>*</span>z);
	G(:,j) = [j<span style=color:#f92672>*</span>h X];
<span style=color:#66d9ef>end</span>
x=G(<span style=color:#ae81ff>2</span>,:);
y=x<span style=color:#f92672>.*</span>beta <span style=color:#f92672>+</span> R<span style=color:#f92672>*</span>randn(size(t));
</code></pre></div><figure><img src=/post/kalman_filter_and_stat_arbitrage/x_and_y.png><figcaption><h4>Generated stocks X & Y</h4></figcaption></figure><h2 id=kalman-filer>Kalman filer</h2><p>Instead of the typical approach to estimate beta using least squares regression, or some kind of rolling regression (to try to take account of the fact that beta may change over time). In this traditional framework, beta is static or slowly changing.<br>In the Kalman framework, beta is itself a random process that evolves continuously over time, as a random walk. Because it is random and contaminated by the noise, we cannot observe beta directly but must infer its (changing) value from the observable stock prices X and Y.<br>Kalman filter has very complicated mathematical and statistical theory behind it. See <a href=https://www.intechopen.com/books/introduction-and-implementations-of-the-kalman-filter/introduction-to-kalman-filter-and-its-applications>here</a> for tutorial. Kalman filter algorithm has two states:</p><ul><li>prediction: in this stage, the algorithm will predict the next beta before it has the stock prices. The prediction is at time t and based on beta values from previous times.</li><li>update: in this stage, the algorithm will update the prediction of beta after it has the stock price at time t.</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-matlab data-lang=matlab>Q=<span style=color:#ae81ff>0.8</span>;
H=<span style=color:#ae81ff>1</span>;
P=<span style=color:#ae81ff>1</span>;
K=<span style=color:#ae81ff>1</span>;
F=[<span style=color:#ae81ff>0.1</span>  <span style=color:#ae81ff>0.1</span> .<span style=color:#ae81ff>8</span>  ];n=<span style=color:#ae81ff>3</span>;
beta_est(<span style=color:#ae81ff>1</span>:n)=beta(<span style=color:#ae81ff>1</span>:n);
clear PP
<span style=color:#66d9ef>for</span> i=n<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>:size(t,<span style=color:#ae81ff>2</span>)
	<span style=color:#75715e>%Prediction</span>
	beta_est(i)=F<span style=color:#f92672>*</span>beta_est(i<span style=color:#f92672>-</span>n:i<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>&#39;</span>;
        P=F<span style=color:#f92672>*</span>P<span style=color:#f92672>*</span>F<span style=color:#f92672>&#39;</span><span style=color:#f92672>+</span>Q;

       <span style=color:#75715e>% uses to decide for trade since index &#39;i&#39;  is a later time, and we have info till time &#39;i-1&#39;.</span>
	beta_pred(i)=F<span style=color:#f92672>*</span>beta_est(i<span style=color:#f92672>-</span>n:i<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>&#39;</span>;
	

	<span style=color:#75715e>% update , it time &#39;i&#39; and the stock info at this time is known</span>
	r= y(i)<span style=color:#f92672>/</span>x(i) <span style=color:#f92672>-</span>beta_est(i);
	K=P^<span style=color:#ae81ff>1</span><span style=color:#f92672>*</span>H<span style=color:#f92672>&#39;</span><span style=color:#f92672>*</span>(R<span style=color:#f92672>+</span>H<span style=color:#f92672>*</span>P^<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>*</span>H<span style=color:#f92672>&#39;</span>)^<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
	beta_est(i)=beta_est(i) <span style=color:#f92672>+</span> K<span style=color:#f92672>*</span>r;
	P=(ones(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>)<span style=color:#f92672>-</span>K<span style=color:#f92672>*</span>H)<span style=color:#f92672>*</span>P;
	PP(<span style=color:#66d9ef>end</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>,:) = [P K];	
<span style=color:#66d9ef>end</span>
</code></pre></div><p>The following figure diplaye kalman filter resolt. The blue graph is the orignal beta, which is hidden variable and cannot diplayed directly. The green one is the preidcted beta which is used by the trade algorithm to take descitiopn about trade. The red graph is estimated beta which calculated right after the update stage.</p><figure><img src=/post/kalman_filter_and_stat_arbitrage/kalman.png><figcaption><h4>Kalman filter resolts</h4></figcaption></figure><h2 id=trading-algorithm>trading algorithm</h2><p>The trading algorithm is very simple and show great resoluts:<div style=overflow:auto;width:auto>$$
position(t)=\left\{
\begin{array}{ll}
1 &  , beta>0  \\
                  -1 & , beta<0 
                \end{array}
\right.
$$</div></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-matlab data-lang=matlab>ii=find  (y<span style=color:#f92672>-</span>beta_pred<span style=color:#f92672>.*</span>x<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>0.0</span>);
s=y<span style=color:#f92672>-</span> beta_pred<span style=color:#f92672>.*</span>x;
s=[<span style=color:#ae81ff>0</span> diff(s)];
ii=ii(<span style=color:#ae81ff>10</span>:<span style=color:#66d9ef>end</span>); <span style=color:#75715e>% ignore the converegance time of kalman filter</span>
figure;plot (cumsum(s(ii)))
xlabel(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>time&#39;</span>);
ylabel(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>equity curve&#39;</span>);
</code></pre></div><figure><img src=/post/kalman_filter_and_stat_arbitrage/equity.png><figcaption><h4>Equity Curve</h4></figcaption></figure><h2 id=conclusions>conclusions</h2><p>The results above are only theoretical and to apply this approach to real stock there arise a lot todo:</p><ol><li>to find a cointegrated pair of stocks.</li><li>to find an automatic way to calibrate the Kalman-filter Q parameter.</li><li>find a more complicated trading algorithm. For example: train a neural network model to get a maximum equity curve with maximum share ration.</li><li>One can choose a better relationship model between stocks of the pair.</li><li>The above equity curve is theoretical only since the synthesized data is stationary, and therefor the equity curve continuously grows. In a real stock pairing, the information is a complete mess, and the statistical characteristics are not known and not stationary. Nevertheless, it seems that the Kalman filter does an outstanding job with beta tracking and has a very high potential to work in the real trading strategy.</li></ol><p>The code for this example is written in Matlab/octave and can be found <a href=/post/kalman_filter_and_stat_arbitrage/kf.m>here</a>.</p><h2 id=references>References</h2><p>[1] <a href=http://jonathankinlay.com/2018/09/statistical-arbitrage-using-kalman-filter/>http://jonathankinlay.com/2018/09/statistical-arbitrage-using-kalman-filter/</a><br>[2] <a href=https://www.intechopen.com/books/introduction-and-implementations-of-the-kalman-filter/introduction-to-kalman-filter-and-its-applications>https://www.intechopen.com/books/introduction-and-implementations-of-the-kalman-filter/introduction-to-kalman-filter-and-its-applications</a><br>[3] <a href=https://robotwealth.com/kalman-filter-pairs-trading-r/>https://robotwealth.com/kalman-filter-pairs-trading-r/</a><br>[4] Algorithmic Trading: Winning Strategies and their Rationale, Wiley, 2013</p></div><div class=content><div class=disqus-comments>Comments<div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"yairgd-github-io-1"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><div class="column is-3"><div class=card><div class=card-content><h1 class="title is-5">Categories</h1><div class=tags><span class=tag><a href=https://yairgd.github.io/categories/algorithm>algorithm</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/development>development</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/embbeded>embbeded</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/emmbeded>emmbeded</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/golang>golang</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/linux>linux</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/python>python</a></span>
<span class=tag><a href=https://yairgd.github.io/categories/qt5>qt5</a></span></div></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Tags</h1><div class=tags><span class=tag><a href=https://yairgd.github.io/tags/bayer>bayer</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/computer-vision>computer-vision</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/development>development</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/eclipse>eclipse</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/embedded>embedded</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/emmbeded>emmbeded</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/go>go</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/golang>golang</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/hugo>hugo</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/kalman-filter>kalman-filter</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/kernel>kernel</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/linux>linux</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/opkg>opkg</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/qt5>qt5</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/rgb>rgb</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/rt>rt</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/statstical-abitrage>statstical-abitrage</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/templates>templates</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/themes>themes</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/yocto>yocto</a></span>
<span class=tag><a href=https://yairgd.github.io/tags/zynq>zynq</a></span></div></div></div><br><div class=card><div class=card-content><h1 class="title is-5">Recent posts</h1><h1><a href=https://yairgd.github.io/2020/09/ecpise-with-cmake-project-on-windows/>Ecpise with cmake project on windows</a></h1><time class="has-text-grey-light is-size-7">12 September 2020</time><h1><a href=https://yairgd.github.io/2020/08/install-linux-on-microzed-board/>install linux on microzed board</a></h1><time class="has-text-grey-light is-size-7">1 August 2020</time><h1><a href=https://yairgd.github.io/2020/06/custom-opkg-repository/>Custom opkg repository</a></h1><time class="has-text-grey-light is-size-7">18 June 2020</time><h1><a href=https://yairgd.github.io/2020/05/kalman-filter-and-pair-trading/>Kalman filter and pair trading</a></h1><time class="has-text-grey-light is-size-7">1 May 2020</time><h1><a href=https://yairgd.github.io/2020/04/simple-hello-world-application-using-qt5-for-embedded-linux-device./>Simple Hello World application using qt5 for embedded Linux device.</a></h1><time class="has-text-grey-light is-size-7">1 April 2020</time></div></div><br><br><div class=card><div class=card-content><h1 class="title is-5">Archives</h1><a href=https://yairgd.github.io/archives/2020>2020</a> (14)<br><a href=https://yairgd.github.io/archives/2014>2014</a> (4)<br></div></div></div></div></div></div><footer class="footer has-background-grey-darker has-text-white"><div class="content has-text-centered"><p><span class="icon is-large"><a href="https://m.facebook.com/yair.gadelov?ref=bookmarks" class=mysocial rel=me><i class="fab fa-facebook fa-3x"></i></a></span>&nbsp;&nbsp;
<span class="icon is-large"><a href=https://www.linkedin.com/mwlite/in/yair-gadelov-1972ab17/ class=mysocial rel=me><i class="fab fa-linkedin fa-3x"></i></a></span>&nbsp;&nbsp;
<span class="icon is-large"><a href=https://github.com/yairgd/ class=mysocial rel=me><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;<br><br>Copyright &copy; Yair Gadelov Tech Blog 2020 - Theme by <a href=https://jeffprod.com class=mysocial>JeffProd.com</a>
- <a class=mysocial href=https://yairgd.github.io/about>About</a><br></p></div></footer><script defer src=https://use.fontawesome.com/releases/v5.1.0/js/all.js></script></body></html>